# GUIA: Como criar uma nova DataTable

## Contexto

DataTable genérico reutilizável em `src/features/components/data-table/`.
Inclui: paginação, busca, filtros facetados, ordenação, visibilidade de colunas,
skeleton de carregamento, e sync bidirecional com a URL.

Implementação de referência: **Funcionários**. Use-a como modelo.

---

## Referência (Funcionários)

Leia estes arquivos ANTES de começar. Cada um é modelo direto para o equivalente da sua feature.

| O que | Caminho |
|---|---|
| Tipos | `src/types/employee.ts` |
| Constantes (roles, statuses, labels) | `src/features/funcionarios/constants.ts` |
| Schema Zod | `src/features/funcionarios/schemas/employeeSchema.ts` |
| Hook de upload | `src/features/funcionarios/hooks/useFileUpload.ts` |
| Service API | `src/features/funcionarios/services/funcionarioService.ts` |
| Mock de dados | `src/mocks/employees.ts` |
| In-memory DB | `src/mocks/in-memory-db.ts` |
| Rota API (lista + POST) | `src/app/api/condominios/[condId]/funcionarios/route.ts` |
| Rota API (por id) | `src/app/api/condominios/[condId]/funcionarios/[funcId]/route.ts` |
| Colunas da tabela | `src/features/funcionarios/components/columns.tsx` |
| Wrapper client | `src/features/funcionarios/components/funcionarios-data-table.tsx` |
| Ações de linha | `src/features/funcionarios/components/data-table-row-actions.tsx` |
| StatusBadge | `src/features/funcionarios/components/status-badge.tsx` |
| Dialog criar/editar | `src/features/funcionarios/components/add-employee-dialog.tsx` |
| Dialog visualizar | `src/features/funcionarios/components/view-employee-dialog.tsx` |
| Page (Server Component) | `src/app/condominios/[condId]/(admin)/funcionarios/page.tsx` |
| Loading (Skeleton) | `src/app/condominios/[condId]/(admin)/funcionarios/loading.tsx` |

---

## Passo a Passo

Substitua `[Feature]`/`[feature]` pelo nome da sua entidade.

### 1. Tipo da entidade
Crie `src/types/[feature].ts` com `[Feature]Summary` (tabela), `[Feature]Detail` (formulários) e `[Feature]Response` (resposta paginada com `data` + `meta`).

### 2. Constantes
Crie `src/features/[feature]/constants.ts` com opções de filtro (com `label`, `value`, `icon`), e `COLUMN_LABELS: Record<string, string>`.

### 3. Service API
Crie `src/features/[feature]/services/[feature]Service.ts` com get, getById, post, put, patch, delete. Use `apiRequest` e `buildQueryString` de `@/lib/api-client`.

**Regra de filtros**: filtros usam arrays paralelos `columns[]` e `content[]`:
```typescript
params?: { page?: number; limit?: number; columns?: string[]; content?: string[]; sort?: string; }
```

### 4. Dados mock
Crie `src/mocks/[feature].ts` e adicione ao `src/mocks/in-memory-db.ts`.

### 5. Rotas API
- `src/app/api/.../[feature]/route.ts` — GET lista paginada + POST
- `src/app/api/.../[feature]/[id]/route.ts` — GET, PUT, PATCH, DELETE

GET aceita: `page`, `limit`, `sort`, `columns[]`, `content[]`.
Filtros processados assim: `getAll('columns')` e `getAll('content')` → monta Map → filtra.
Coluna `name` usa `startsWith`; demais usam match exato.

### 6. Colunas (columns.tsx)
Crie `src/features/[feature]/components/columns.tsx` (`'use client'`).
Use `DataTableColumnHeader` de `@/features/components/data-table`.
Colunas com filtro facetado precisam de `filterFn: (row, id, value) => value.includes(row.getValue(id))`.
Última coluna: `{ id: 'actions', cell: ... }`.

### 7. Wrapper client (OBRIGATÓRIO)
Crie `src/features/[feature]/components/[feature]-data-table.tsx` (`'use client'`).
Recebe APENAS `data` e `pageCount`. Importa internamente columns, constantes e dialogs.
Passa para `<DataTable>`: columns, searchColumnId, searchPlaceholder, facetedFilters, columnLabels, filterMappings, actions.

**filterMappings** usa apenas `{ columnId, isArray? }` — sem `urlParam`:
```typescript
filterMappings={[
  { columnId: 'name' },
  { columnId: 'role', isArray: true },
  { columnId: 'status', isArray: true },
]}
```

**Por que é obrigatório**: page.tsx é Server Component; columns tem funções não serializáveis. O wrapper resolve isso.

### 8. Ações de linha (opcional)
Crie `data-table-row-actions.tsx` com DropdownMenu (ver, editar, ativar/desativar, excluir). Use `router.refresh()` após ações.

### 9. Schema Zod e hooks
Crie `schemas/[feature]Schema.ts` com schema + type inferido. Use `z.enum` das constantes.
Se tiver upload: crie `hooks/useFileUpload.ts`. Envolva funções em `useCallback`.

### 10. Dialogs (opcional)
Dialog criar/editar com `react-hook-form` + schema. Dialog visualizar em modo leitura.

### 11. Page (Server Component)
Crie `src/app/.../[feature]/page.tsx`. Extrai `columns`/`content` de searchParams (normalizar para array), chama o service, renderiza o wrapper passando `data` e `pageCount`.

### 12. Loading (Skeleton)
Crie `src/app/.../[feature]/loading.tsx`. Use `DataTableSkeleton` de `@/features/components/data-table`.
O layout deve espelhar a page.tsx. Props: `columnCount`, `rowCount`, `filterCount`, `showSearch`, `showActions`.

---

## Componentes genéricos (NÃO recrie)

Importar de `@/features/components/data-table`:

| Componente | Quando usar |
|---|---|
| `DataTable` | No wrapper client |
| `DataTableColumnHeader` | No columns.tsx |
| `DataTableSkeleton` | No loading.tsx |

Os demais (`Toolbar`, `Pagination`, `FacetedFilter`, `ViewOptions`) são internos do DataTable.

Utilitários em `src/lib/api-client.ts`: `apiRequest`, `buildQueryString`.

---

## Estrutura de pastas

```
src/types/[feature].ts
src/mocks/[feature].ts
src/features/[feature]/
  ├── constants.ts
  ├── schemas/[feature]Schema.ts
  ├── hooks/useFileUpload.ts               (se aplicável)
  ├── services/[feature]Service.ts
  └── components/
      ├── columns.tsx
      ├── [feature]-data-table.tsx          (wrapper, OBRIGATÓRIO)
      ├── data-table-row-actions.tsx
      ├── status-badge.tsx
      ├── add-[feature]-dialog.tsx
      └── view-[feature]-dialog.tsx
src/app/api/.../[feature]/
  ├── route.ts
  └── [id]/route.ts
src/app/.../[feature]/
  ├── page.tsx
  └── loading.tsx
```

---

## Checklist

- [ ] Tipo da entidade
- [ ] Constantes
- [ ] Service API
- [ ] Mock + in-memory-db
- [ ] Rotas API (lista + por id)
- [ ] columns.tsx
- [ ] Wrapper client
- [ ] Row actions
- [ ] Schema Zod
- [ ] Dialogs (criar/editar + visualizar)
- [ ] StatusBadge
- [ ] page.tsx
- [ ] loading.tsx
